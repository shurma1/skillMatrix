import{r,aj as $,a2 as K,W,j as e,z as q,C as k,T as z,P as I,S as L,B as p,O as h,D as H,d as G,bv as N,bP as F,bQ as _,bR as J}from"./index-C2zTCuKe.js";import{R as A}from"./index-G1xJ3cLY.js";import{R as M}from"./index-D_6T43LE.js";var X={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"}},{tag:"path",attrs:{d:"M464 688a48 48 0 1096 0 48 48 0 10-96 0zm24-112h48c4.4 0 8-3.6 8-8V296c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8z"}}]},name:"exclamation-circle",theme:"outlined"},Y=function(u,t){return r.createElement($,K({},u,{ref:t,icon:X}))},Z=r.forwardRef(Y);const{Title:R,Text:B}=z,ee=i=>{const[u,t]=r.useState(0),n=3,l=r.useCallback(s=>{s.preventDefault(),t(g=>g+1),h.warning("Копирование запрещено во время тестирования")},[]),c=r.useCallback(s=>{s.preventDefault()},[]),d=r.useCallback(s=>{(s.ctrlKey&&(s.key==="c"||s.key==="v"||s.key==="a"||s.key==="s")||s.key==="F12"||s.ctrlKey&&s.shiftKey&&s.key==="I")&&(s.preventDefault(),t(g=>g+1),h.warning("Данное действие запрещено во время тестирования"))},[]),o=r.useCallback(()=>{document.hidden&&(t(s=>s+1),h.error("Обнаружена смена вкладки. Тест завершен."),setTimeout(()=>i(),100))},[i]);return r.useEffect(()=>(document.addEventListener("copy",l),document.addEventListener("cut",l),document.addEventListener("contextmenu",c),document.addEventListener("keydown",d),document.addEventListener("visibilitychange",o),document.body.style.userSelect="none",document.body.style.webkitUserSelect="none",()=>{document.removeEventListener("copy",l),document.removeEventListener("cut",l),document.removeEventListener("contextmenu",c),document.removeEventListener("keydown",d),document.removeEventListener("visibilitychange",o),document.body.style.userSelect="",document.body.style.webkitUserSelect=""}),[l,c,d,o]),{violations:u,maxViolations:n}},te=(i,u)=>{const[t,n]=r.useState(i);r.useEffect(()=>{if(t<=0){u();return}const d=setInterval(()=>{n(o=>o-1)},1e3);return()=>clearInterval(d)},[t,u]);const l=d=>{const o=Math.floor(d/60),s=d%60;return`${o.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},c=(i-t)/i*100;return{timeLeft:t,formatTime:l(t),progressPercent:c}},se=({test:i,onSubmitAnswer:u,onEndTest:t,loading:n=!1})=>{const[l,c]=r.useState(0),[d,o]=r.useState({}),[s,g]=r.useState(!1),[v,j]=W.useModal(),y=()=>{if(console.log("TestTakeUI handleEndTest called",{submitted:s}),s){console.log("Test already submitted, returning");return}console.log("Setting submitted to true and calling onEndTest"),g(!0),t()},{violations:f,maxViolations:b}=ee(y),{timeLeft:w,formatTime:S,progressPercent:a}=te(i.timeLimit,()=>{h.error("Время истекло! Тест завершен."),y()}),x=i.questions[l],T=l===i.questions.length-1,Q=Object.keys(d).length/i.questions.length*100,D=(m,C)=>{o(U=>({...U,[m]:C})),u(m,C)},O=()=>{T||c(m=>m+1)},V=()=>{l>0&&c(m=>m-1)},E=()=>{console.log("showEndTestConfirmation called"),v.confirm({title:"Завершить тест?",icon:e.jsx(Z,{}),content:"Вы уверены, что хотите завершить тест? Это действие нельзя отменить.",okText:"Да, завершить",cancelText:"Отмена",onOk:()=>{console.log("Modal confirmed, calling handleEndTest"),y()}})};return r.useEffect(()=>{f>=b&&v.error({title:"Тест завершен",content:"Превышено количество нарушений правил тестирования. Тест автоматически завершен.",onOk:y})},[f,b,v]),n?e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh"},children:e.jsx(q,{size:"large"})}):e.jsxs("div",{style:{maxWidth:800,margin:"0 auto",padding:"24px"},children:[j,e.jsxs(k,{style:{marginBottom:24},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx(R,{level:3,style:{margin:0},children:"Тест"}),e.jsxs(B,{type:"secondary",children:["Вопрос ",l+1," из ",i.questions.length]})]}),e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx("div",{style:{fontSize:"24px",fontWeight:"bold"},children:S}),e.jsx(I,{percent:a,size:"small",status:w<300?"exception":"normal",showInfo:!1})]})]}),f>0&&e.jsx("div",{style:{marginTop:16,padding:"8px 12px",borderRadius:4,border:"1px solid var(--ant-color-warning-border)",backgroundColor:"var(--ant-color-warning-bg)"},children:e.jsxs(B,{type:"warning",children:["Предупреждений: ",f,"/",b]})})]}),e.jsx(I,{percent:Q,style:{marginBottom:24},strokeColor:{"0%":"#108ee9","100%":"#87d068"}}),e.jsxs(k,{style:{marginBottom:24},children:[e.jsx(R,{level:4,style:{marginBottom:24},children:x.text}),e.jsx(A.Group,{value:d[x.id]||"",onChange:m=>D(x.id,m.target.value),style:{width:"100%"},children:e.jsx(L,{direction:"vertical",style:{width:"100%"},children:x.answerVariants.map(m=>e.jsx(A,{value:m.id,style:{padding:"12px",border:"1px solid var(--ant-color-border)",borderRadius:4,marginBottom:8,width:"100%"},children:m.text},m.id))})})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(p,{onClick:V,disabled:l===0,children:"Предыдущий вопрос"}),e.jsxs(L,{children:[e.jsx(p,{danger:!0,onClick:E,children:"Завершить тест"}),T?e.jsx(p,{type:"primary",onClick:E,disabled:!d[x.id],children:"Завершить тест"}):e.jsx(p,{type:"primary",onClick:O,disabled:!d[x.id],children:"Следующий вопрос"})]})]})]})},{Title:P}=z,ne=()=>{const{testId:i=""}=H(),u=G(),t=N(a=>a.auth.user),[n,l]=r.useState(null),[c,d]=r.useState(!1),[o,s]=r.useState(!1),[g,{isLoading:v}]=F(),[j]=_(),[y]=J();if(!t)return e.jsx(M,{status:"warning",title:"Необходима авторизация",subTitle:"Для прохождения теста необходимо войти в систему",extra:[e.jsx(p,{type:"primary",onClick:()=>u("/login"),children:"Войти"},"login")]});const f=async()=>{try{const a=await g({userId:t.id,testId:i}).unwrap();l(a),d(!0),h.success("Тест начат")}catch(a){console.error("Error starting test:",a),h.error("Ошибка при запуске теста")}},b=async(a,x)=>{if(n)try{await y({sessionId:n.sessionId,questionId:a,answerId:x}).unwrap()}catch(T){console.error("Error sending answer:",T),h.error("Ошибка при отправке ответа")}},w=async()=>{if(console.log("handleEndTest called",{testSession:n,testCompleted:o,user:t}),!n||o){console.log("Early return from handleEndTest",{testSession:n,testCompleted:o});return}if(!t?.id){console.error("User ID is missing"),h.error("Ошибка: не найден ID пользователя");return}try{console.log("Calling endTest API with:",{userId:t.id,sessionId:n.sessionId});const a=await j({userId:t.id,sessionId:n.sessionId}).unwrap();console.log("endTest API response:",a),s(!0),h.success("Тест завершен"),setTimeout(()=>{u(`/test/${i}/result/view`)},2e3)}catch(a){console.error("Error ending test:",a),h.error("Ошибка при завершении теста")}},S=()=>{u("/")};return r.useEffect(()=>{const a=x=>{c&&!o&&(x.preventDefault(),x.returnValue="Вы уверены, что хотите покинуть страницу? Тест будет завершен.")};return window.addEventListener("beforeunload",a),()=>{window.removeEventListener("beforeunload",a)}},[c,o]),r.useEffect(()=>()=>{n&&c&&!o&&t&&j({userId:t.id,sessionId:n.sessionId})},[n,c,o,t,j]),o?e.jsx(M,{status:"success",title:"Тест завершен!",subTitle:"Ваши ответы отправлены на проверку. Результаты будут доступны после обработки.",extra:[e.jsx(p,{type:"primary",onClick:S,children:"На главную"},"home")]}):!c||!n?e.jsxs("div",{style:{maxWidth:600,margin:"0 auto",padding:"48px 24px",textAlign:"center"},children:[e.jsx(P,{level:2,children:"Готовы начать тест?"}),e.jsxs("div",{style:{padding:"24px",borderRadius:"8px",marginBottom:"32px",textAlign:"left",border:"1px solid",borderColor:"var(--ant-color-border)"},children:[e.jsx(P,{level:4,children:"Правила прохождения теста:"}),e.jsxs("ul",{style:{paddingLeft:"20px"},children:[e.jsx("li",{children:"Не покидайте страницу во время тестирования"}),e.jsx("li",{children:"Запрещено копирование и использование внешних материалов"}),e.jsx("li",{children:"Время ограничено - следите за таймером"}),e.jsx("li",{children:"Каждое нарушение фиксируется системой"}),e.jsx("li",{children:"При превышении лимита нарушений тест будет автоматически завершен"})]})]}),e.jsx(p,{type:"primary",size:"large",loading:v,onClick:f,children:"Начать тест"})]}):e.jsx(se,{test:n.test,sessionId:n.sessionId,onSubmitAnswer:b,onEndTest:w})},le=()=>e.jsx(ne,{});export{le as default};
