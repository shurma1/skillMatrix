import{j as e,I as x,z as C,Q as k,B as F,U as O,r as o,V as f,w as R,F as u,W as T,d as q,X as z,Y as P,c as E,T as L,O as y}from"./index-C2zTCuKe.js";import{u as M}from"./useDebounce-C9xaHpZH.js";import{F as Q}from"./Table-Ck7p-nsh.js";import"./index-G1xJ3cLY.js";import"./Pagination-Bu1Ky6rp.js";import"./FileOutlined-2qhVAVZV.js";const B=({value:a,onChange:s,loading:r,placeholder:t})=>e.jsx(x,{allowClear:!0,value:a,placeholder:t||"Поиск (ФИО / логин / email)",onChange:i=>s(i.target.value),prefix:e.jsx(k,{style:{color:"#999"}}),suffix:r?e.jsx(C,{size:"small"}):void 0}),$=({query:a,loading:s,onQueryChange:r,onCreateClick:t})=>e.jsxs("div",{style:{display:"flex",gap:16,alignItems:"center",width:"100%",marginBottom:16},children:[e.jsx("div",{style:{flex:1},children:e.jsx(B,{value:a,onChange:r,loading:s})}),e.jsx(F,{type:"primary",onClick:t,style:{whiteSpace:"nowrap"},children:"Добавить нового пользователя"})]}),_=({user:a,size:s=40})=>{const r=a.avatar_id||void 0,{data:t,isFetching:i}=O({id:r,thumb:!0},{skip:!r}),[c,l]=o.useState(null);o.useEffect(()=>{if(t){const n=URL.createObjectURL(t);return l(n),()=>URL.revokeObjectURL(n)}l(null)},[t]);const p=o.useMemo(()=>{const n=[a.lastname,a.firstname,a.patronymic].filter(Boolean);return n.length?n.map(m=>m[0]).join("").slice(0,2).toUpperCase():a.login.slice(0,2).toUpperCase()},[a]);return r?e.jsx(R,{title:`${a.lastname} ${a.firstname}`.trim(),children:e.jsx(f,{size:s,src:c||void 0,children:i?e.jsx(C,{size:"small"}):p})}):e.jsx(f,{size:s,children:p})},A=({data:a,loading:s,total:r,page:t,pageSize:i,onPageChange:c,onRowClick:l})=>{const p=[{title:"",dataIndex:"avatar_id",width:56,render:(n,m)=>e.jsx(_,{user:m,size:40})},{title:"Фамилия",dataIndex:"lastname"},{title:"Имя",dataIndex:"firstname"},{title:"Отчество",dataIndex:"patronymic"},{title:"Логин",dataIndex:"login"},{title:"Email",dataIndex:"email"}];return e.jsx(Q,{size:"middle",rowKey:n=>n.id,loading:s,dataSource:a,pagination:{current:t,pageSize:i,total:r,onChange:c,showSizeChanger:!0},onRow:n=>({onClick:()=>l(n)}),columns:p})},D=({open:a,confirmLoading:s,onCancel:r,onSubmit:t})=>{const[i]=u.useForm(),c=async()=>{try{const l=await i.validateFields();t(l)}catch{}};return e.jsx(T,{open:a,title:"Добавить пользователя",onCancel:r,onOk:c,confirmLoading:s,okText:"Добавить",cancelText:"Отмена",destroyOnHidden:!0,children:e.jsxs(u,{form:i,layout:"vertical",preserve:!1,children:[e.jsx(u.Item,{name:"login",label:"Логин",rules:[{required:!0,message:"Введите логин"}],children:e.jsx(x,{})}),e.jsx(u.Item,{name:"lastname",label:"Фамилия",rules:[{required:!0,message:"Введите фамилию"}],children:e.jsx(x,{})}),e.jsx(u.Item,{name:"firstname",label:"Имя",rules:[{required:!0,message:"Введите имя"}],children:e.jsx(x,{})}),e.jsx(u.Item,{name:"patronymic",label:"Отчество",rules:[{required:!0,message:"Введите отчество"}],children:e.jsx(x,{})}),e.jsx(u.Item,{name:"email",label:"Email",rules:[{type:"email",message:"Некорректный email"},{required:!1}],children:e.jsx(x,{})}),e.jsx(u.Item,{name:"password",label:"Пароль",rules:[{required:!0,message:"Введите пароль"},{min:6,message:"Пароль должен быть не менее 6 символов"}],children:e.jsx(x.Password,{})})]})})},G=()=>{const a=q(),[s,r]=o.useState(""),t=M(s,600),[i,c]=o.useState(1),[l,p]=o.useState(10),[n,m]=o.useState(!1),{data:h,isFetching:j}=z({query:t||" ",limit:l,page:i},{skip:!t&&t!==""}),[v,{isLoading:b}]=P();o.useEffect(()=>{c(1)},[t]);const I=(g,d)=>{c(g),p(d)},U=async g=>{try{const d=await v(g).unwrap();y.success("Пользователь создан"),m(!1),a(`/users/${d.id}/`)}catch(d){const S=d&&typeof d=="object"&&"data"in d?d.data?.message:"Ошибка создания пользователя";y.error(S||"Ошибка создания пользователя")}},w=o.useCallback(g=>{a(`/users/${g.id}/`)},[a]);return e.jsxs(E,{vertical:!0,children:[e.jsx(L.Title,{level:3,style:{marginTop:0,marginBottom:16},children:"Пользователи"}),e.jsx($,{query:s,loading:j,onQueryChange:r,onCreateClick:()=>m(!0)}),e.jsx(A,{data:h?.rows||[],loading:j,total:h?.count||0,page:i,pageSize:l,onPageChange:I,onRowClick:w}),e.jsx(D,{open:n,confirmLoading:b,onCancel:()=>m(!1),onSubmit:U})]})},Y=()=>e.jsx(G,{});export{Y as default};
