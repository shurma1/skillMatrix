const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-LkfTSMFh.js","assets/index-C2zTCuKe.js","assets/index-KrfumMBl.css"])))=>i.map(i=>d[i]);
import{r as o,aj as H,a2 as T,bv as oe,aF as ie,bw as q,O as v,j as e,C as te,S as I,T as re,B as g,bx as Z,by as N,z as J,A as u,bz as ae,D as ce,d as le,b as de,E as ue,M as xe,bA as he,bB as fe,bC as pe,bD as ee}from"./index-C2zTCuKe.js";import{S as ge}from"./SkillLevelDisplay-BktIxDca.js";import{R as me}from"./FileOutlined-2qhVAVZV.js";import{C as we,F as ye}from"./Table-Ck7p-nsh.js";import"./SkillLevelSelect-D_L04xpJ.js";import"./index-G1xJ3cLY.js";import"./Pagination-Bu1Ky6rp.js";var ve={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M854.6 288.6L639.4 73.4c-6-6-14.1-9.4-22.6-9.4H192c-17.7 0-32 14.3-32 32v832c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V311.3c0-8.5-3.4-16.7-9.4-22.7zM790.2 326H602V137.8L790.2 326zm1.8 562H232V136h302v216a42 42 0 0042 42h216v494zM504 618H320c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h184c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8zM312 490v48c0 4.4 3.6 8 8 8h384c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8H320c-4.4 0-8 3.6-8 8z"}}]},name:"file-text",theme:"outlined"},je=function(r,i){return o.createElement(H,T({},r,{ref:i,icon:ve}))},G=o.forwardRef(je),be={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M553.1 509.1l-77.8 99.2-41.1-52.4a8 8 0 00-12.6 0l-99.8 127.2a7.98 7.98 0 006.3 12.9H696c6.7 0 10.4-7.7 6.3-12.9l-136.5-174a8.1 8.1 0 00-12.7 0zM360 442a40 40 0 1080 0 40 40 0 10-80 0zm494.6-153.4L639.4 73.4c-6-6-14.1-9.4-22.6-9.4H192c-17.7 0-32 14.3-32 32v832c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V311.3c0-8.5-3.4-16.7-9.4-22.7zM790.2 326H602V137.8L790.2 326zm1.8 562H232V136h302v216a42 42 0 0042 42h216v494z"}}]},name:"file-image",theme:"outlined"},ke=function(r,i){return o.createElement(H,T({},r,{ref:i,icon:be}))},Se=o.forwardRef(ke),Le={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M531.3 574.4l.3-1.4c5.8-23.9 13.1-53.7 7.4-80.7-3.8-21.3-19.5-29.6-32.9-30.2-15.8-.7-29.9 8.3-33.4 21.4-6.6 24-.7 56.8 10.1 98.6-13.6 32.4-35.3 79.5-51.2 107.5-29.6 15.3-69.3 38.9-75.2 68.7-1.2 5.5.2 12.5 3.5 18.8 3.7 7 9.6 12.4 16.5 15 3 1.1 6.6 2 10.8 2 17.6 0 46.1-14.2 84.1-79.4 5.8-1.9 11.8-3.9 17.6-5.9 27.2-9.2 55.4-18.8 80.9-23.1 28.2 15.1 60.3 24.8 82.1 24.8 21.6 0 30.1-12.8 33.3-20.5 5.6-13.5 2.9-30.5-6.2-39.6-13.2-13-45.3-16.4-95.3-10.2-24.6-15-40.7-35.4-52.4-65.8zM421.6 726.3c-13.9 20.2-24.4 30.3-30.1 34.7 6.7-12.3 19.8-25.3 30.1-34.7zm87.6-235.5c5.2 8.9 4.5 35.8.5 49.4-4.9-19.9-5.6-48.1-2.7-51.4.8.1 1.5.7 2.2 2zm-1.6 120.5c10.7 18.5 24.2 34.4 39.1 46.2-21.6 4.9-41.3 13-58.9 20.2-4.2 1.7-8.3 3.4-12.3 5 13.3-24.1 24.4-51.4 32.1-71.4zm155.6 65.5c.1.2.2.5-.4.9h-.2l-.2.3c-.8.5-9 5.3-44.3-8.6 40.6-1.9 45 7.3 45.1 7.4zm191.4-388.2L639.4 73.4c-6-6-14.1-9.4-22.6-9.4H192c-17.7 0-32 14.3-32 32v832c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V311.3c0-8.5-3.4-16.7-9.4-22.7zM790.2 326H602V137.8L790.2 326zm1.8 562H232V136h302v216a42 42 0 0042 42h216v494z"}}]},name:"file-pdf",theme:"outlined"},ze=function(r,i){return o.createElement(H,T({},r,{ref:i,icon:Le}))},Ce=o.forwardRef(ze),Ie={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M854.6 288.7L639.4 73.4c-6-6-14.2-9.4-22.7-9.4H192c-17.7 0-32 14.3-32 32v832c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V311.3c0-8.5-3.4-16.6-9.4-22.6zM790.2 326H602V137.8L790.2 326zm1.8 562H232V136h302v216a42 42 0 0042 42h216v494zM402 549c0 5.4 4.4 9.5 9.8 9.5h32.4c5.4 0 9.8-4.2 9.8-9.4 0-28.2 25.8-51.6 58-51.6s58 23.4 58 51.5c0 25.3-21 47.2-49.3 50.9-19.3 2.8-34.5 20.3-34.7 40.1v32c0 5.5 4.5 10 10 10h32c5.5 0 10-4.5 10-10v-12.2c0-6 4-11.5 9.7-13.3 44.6-14.4 75-54 74.3-98.9-.8-55.5-49.2-100.8-108.5-101.6-61.4-.7-111.5 45.6-111.5 103zm78 195a32 32 0 1064 0 32 32 0 10-64 0z"}}]},name:"file-unknown",theme:"outlined"},Fe=function(r,i){return o.createElement(H,T({},r,{ref:i,icon:Ie}))},De=o.forwardRef(Fe);const Me=(t,r)=>t==="application/pdf"||r.toLowerCase().endsWith(".pdf"),Ee=(t,r)=>t==="application/vnd.openxmlformats-officedocument.wordprocessingml.document"||r.toLowerCase().endsWith(".docx"),Re=(t,r)=>t==="application/msword"||r.toLowerCase().endsWith(".doc"),$e=(t,r)=>t==="application/vnd.openxmlformats-officedocument.presentationml.presentation"||t==="application/vnd.ms-powerpoint"||r.toLowerCase().endsWith(".pptx")||r.toLowerCase().endsWith(".ppt"),Ae=(t,r)=>t==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||t==="application/vnd.ms-excel"||r.toLowerCase().endsWith(".xlsx")||r.toLowerCase().endsWith(".xls"),Oe=(t,r)=>t==="text/plain"||r.toLowerCase().endsWith(".txt"),He=(t,r)=>t.startsWith("image/")||/\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i.test(r),Te=(t,r)=>Me(t,r)?"PDF документ":Ee(t,r)?"Word документ (DOCX)":Re(t,r)?"Word документ (DOC)":$e(t,r)?"PowerPoint презентация":Ae(t,r)?"Excel таблица":Oe(t,r)?"Текстовый документ":He(t,r)?"Изображение":"Документ",Ue=t=>{const r=["Б","КБ","МБ","ГБ"];if(t===0)return"0 Б";const i=Math.floor(Math.log(t)/Math.log(1024));return Math.round(t/Math.pow(1024,i)*100)/100+" "+r[i]},_e=t=>window.URL.createObjectURL(t),Be=(t,r)=>{const i=_e(t),c=document.createElement("a");c.href=i,c.download=r,document.body.appendChild(c),c.click(),window.URL.revokeObjectURL(i),document.body.removeChild(c)};let C=null,O=null;const{Text:Q}=re,We=({fileId:t,fileName:r,fileSize:i,mimeType:c})=>{const[d,F]=o.useState(null),[m,U]=o.useState(null),[x,_]=o.useState(null),[D,w]=o.useState([]),[B,j]=o.useState(!0),[b,W]=o.useState(null),[M,k]=o.useState(null),[S,E]=o.useState(!1),[f,R]=o.useState(!0),h=oe(n=>n.auth.accessToken),L=Ue(i),$=Te(c,r),p=o.useMemo(()=>{const n=r.toLowerCase();return c==="application/pdf"||n.endsWith(".pdf")?"pdf":c.startsWith("image/")||/(png|jpe?g|gif|webp|bmp|svg)$/i.test(n)?"image":c.startsWith("text/")||n.endsWith(".txt")||n.endsWith(".log")?"text":/\.docx$/i.test(n)?"docx":/\.xlsx$/i.test(n)?"xlsx":"unsupported"},[c,r]),z=()=>{if(!C?.images)throw new Error("Mammoth library not loaded");return C.images.inline(async n=>{const s=await n.read("base64");return{src:`data:${n.contentType};base64,${s}`}})},V=o.useCallback(async n=>{const s=`${ie}/api/file/${t}`,l=await fetch(s,{method:"GET",headers:{Authorization:`Bearer ${h}`},credentials:"include",signal:n});if(!l.ok)throw new Error(`Ошибка загрузки файла: ${l.status} ${l.statusText}`);return l.blob()},[t,h]),P=async n=>{try{C||(C=await N(()=>import("./index-LkfTSMFh.js").then(l=>l.i),__vite__mapDeps([0,1,2])));const s=await C.convertToHtml({arrayBuffer:n},{convertImage:z()});f&&U(s.value)}catch(s){throw console.error("DOCX processing error:",s),s}},X=async n=>{try{O||(O=await N(()=>import("./xlsx-hHwYTrUW.js"),[]));const s=O.read(n,{type:"array"}),l=s.SheetNames.map(A=>({name:A,html:O.utils.sheet_to_html(s.Sheets[A])}));f&&w(l)}catch(s){throw console.error("XLSX processing error:",s),s}},a=async n=>{try{const s=await n.text();f&&_(s)}catch(s){throw console.error("Text processing error:",s),s}},y=n=>{const s=URL.createObjectURL(n);return f&&F(s),s},K=o.useCallback(async()=>{if(!h){k("Отсутствует токен авторизации"),j(!1);return}j(!0),k(null);const n=new AbortController;try{const s=await V(n.signal);if(!f)return;switch(W(s),p){case"pdf":case"image":y(s);break;case"text":await a(s);break;case"docx":const l=await s.arrayBuffer();await P(l);break;case"xlsx":const A=await s.arrayBuffer();await X(A);break;case"unsupported":break;default:throw new Error(`Неподдерживаемый тип файла: ${p}`)}}catch(s){if(s instanceof Error&&s.name==="AbortError")return;const l=q(s);console.error("Error loading file:",s),f&&(k(l),v.error(`Ошибка загрузки документа: ${l}`))}finally{f&&j(!1)}return()=>{n.abort()}},[h,p,t]),Y=async()=>{if(!b){v.error("Файл не загружен");return}E(!0);try{await Be(b,r),v.success("Файл скачан")}catch(n){const s=q(n);v.error(`Ошибка скачивания: ${s}`)}finally{E(!1)}},se=()=>{if(B)return e.jsxs("div",{style:{textAlign:"center",padding:"40px"},children:[e.jsx(J,{size:"large"}),e.jsx("div",{style:{marginTop:16},children:e.jsx(Q,{type:"secondary",children:"Загрузка документа..."})})]});if(M)return e.jsx(u,{type:"error",showIcon:!0,message:"Ошибка загрузки документа",description:M,action:e.jsx(g,{size:"small",onClick:K,children:"Повторить"})});switch(p){case"pdf":return d?e.jsx("iframe",{src:d,style:{width:"100%",height:"70vh",border:"none"},title:r}):e.jsx(u,{type:"warning",message:"PDF не загружен"});case"image":return d?e.jsx("div",{style:{textAlign:"center",maxHeight:"70vh",overflow:"auto"},children:e.jsx("img",{src:d,alt:r,style:{maxWidth:"100%",height:"auto"}})}):e.jsx(u,{type:"warning",message:"Изображение не загружено"});case"text":return x?e.jsx("pre",{style:{whiteSpace:"pre-wrap",maxHeight:"70vh",overflow:"auto",padding:"16px",backgroundColor:"#f5f5f5",borderRadius:"4px"},children:x}):e.jsx(u,{type:"warning",message:"Текст не загружен"});case"docx":return m?e.jsx("div",{style:{maxHeight:"70vh",overflow:"auto"},children:e.jsx("div",{className:"docx-content",dangerouslySetInnerHTML:{__html:m}})}):e.jsx(u,{type:"warning",showIcon:!0,message:"Не удалось отобразить DOCX",description:"Скачайте файл для просмотра в Word."});case"xlsx":return D.length>0?e.jsx("div",{style:{maxHeight:"70vh",overflow:"auto"},children:e.jsx(ae,{items:D.map((n,s)=>({key:s.toString(),label:n.name,children:e.jsx("div",{dangerouslySetInnerHTML:{__html:n.html},style:{overflow:"auto"}})}))})}):e.jsx(u,{type:"warning",message:"Не удалось обработать XLSX файл"});case"unsupported":return e.jsx(u,{type:"info",showIcon:!0,message:"Предварительный просмотр недоступен",description:`Файл типа ${$} не поддерживается для просмотра. Скачайте файл для открытия в соответствующем приложении.`,action:e.jsx(g,{type:"primary",icon:e.jsx(Z,{}),onClick:Y,loading:S,children:"Скачать"})});default:return e.jsx(u,{type:"error",message:"Неизвестный тип документа"})}},ne=()=>{switch(p){case"pdf":return e.jsx(Ce,{style:{color:"#ff4d4f"}});case"image":return e.jsx(Se,{style:{color:"#52c41a"}});case"text":return e.jsx(G,{style:{color:"#1890ff"}});case"docx":return e.jsx(G,{style:{color:"#1890ff"}});case"xlsx":return e.jsx(G,{style:{color:"#52c41a"}});default:return e.jsx(De,{style:{color:"#999"}})}};return o.useEffect(()=>(K(),()=>{R(!1),d&&URL.revokeObjectURL(d)}),[t,h,p]),o.useEffect(()=>()=>{d&&URL.revokeObjectURL(d)},[d]),e.jsx(te,{children:e.jsxs(I,{direction:"vertical",size:"middle",style:{width:"100%"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(I,{children:[ne(),e.jsxs("div",{children:[e.jsx(Q,{strong:!0,children:r}),e.jsx("div",{children:e.jsxs(Q,{type:"secondary",children:[$," • ",L]})})]})]}),e.jsx(g,{icon:e.jsx(Z,{}),onClick:Y,loading:S,disabled:!b,children:"Скачать"})]}),se()]})})},{Title:Ve,Text:Pe}=re,Xe=()=>{const{skillId:t=""}=ce(),r=le(),i=de(a=>a.auth.user),c=i?.id?.toString()||"",[d,F]=o.useState(!1),[m,U]=o.useState(!1),{data:x,isFetching:_,error:D}=ue(t,{skip:!t}),{data:w,isFetching:B,error:j}=xe(x?.fileId,{skip:!x?.fileId}),{data:b,isFetching:W}=he({id:c,skillId:t},{skip:!t||!c}),[M,{isLoading:k}]=fe(),S=D||j,E=_||B||W,f=!!(x?.fileId&&w),R=x?.type==="document",h=b?.confirmations||[],L=h.length===0?0:[...h].reverse()[0]?.level||0,$=L===0&&!m,p=L>0||m,z=()=>{r(`/skills/${t}`)},V=a=>{F(a)},P=async()=>{if(!x?.fileId){v.error("Файл не найден");return}try{await M(x.fileId).unwrap(),U(!0),F(!1)}catch(a){const y=a&&typeof a=="object"&&"data"in a&&typeof a.data?.message=="string"?a.data.message:"Ошибка подтверждения ознакомления";v.error(y)}},X=()=>{const a=[{title:"Статус",key:"status",render:()=>e.jsxs("span",{style:{color:"#52c41a"},children:[e.jsx(ee,{})," Ознакомлен"]})},{title:"Текущий уровень",key:"level",render:()=>e.jsx(ge,{level:L})},{title:"Дата последнего подтверждения",key:"date",render:()=>{if(h.length===0)return"-";const y=[...h].reverse()[0];if(!y)return"-";try{return new Date(y.date).toLocaleDateString("ru-RU")}catch{return y.date}}}];return e.jsx(ye,{columns:a,dataSource:[{key:"user-acknowledgment"}],pagination:!1,size:"small"})};return E?e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px"},children:e.jsx(J,{size:"large"})}):i?S?e.jsx("div",{style:{padding:"24px"},children:e.jsx(u,{message:"Ошибка загрузки",description:q(S)||"Не удалось загрузить информацию о навыке или файле",type:"error",showIcon:!0,action:e.jsx(g,{size:"small",onClick:z,children:"Вернуться к навыку"})})}):!R||!f?e.jsx("div",{style:{padding:"24px"},children:e.jsx(u,{message:"Документ недоступен",description:R?"К навыку не прикреплен файл документа":"Этот навык не содержит документа для просмотра",type:"info",showIcon:!0,action:e.jsx(g,{size:"small",onClick:z,children:"Вернуться к навыку"})})}):e.jsx("div",{style:{padding:"24px"},children:e.jsxs(I,{direction:"vertical",size:"large",style:{width:"100%"},children:[e.jsxs("div",{children:[e.jsx(g,{type:"text",icon:e.jsx(pe,{}),onClick:z,style:{marginBottom:"16px"},children:"Вернуться к навыку"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",marginBottom:"8px"},children:[e.jsx(me,{style:{fontSize:"20px",color:"#1890ff"}}),e.jsx(Ve,{level:2,style:{margin:0},children:x.title})]}),e.jsxs(Pe,{type:"secondary",children:["Документ: ",w?.name||"Загрузка..."]})]}),e.jsx(We,{fileId:x.fileId,fileName:w.name,fileSize:w.size,mimeType:w.mimeType}),e.jsx(te,{title:"Подтверждение ознакомления",style:{marginTop:"24px"},extra:p&&e.jsx(ee,{style:{color:"#52c41a"}}),children:$?e.jsx(I,{direction:"vertical",size:"middle",style:{width:"100%"},children:k?e.jsxs("div",{style:{textAlign:"center",padding:"20px"},children:[e.jsx(J,{size:"large"}),e.jsx("div",{style:{marginTop:"16px",fontSize:"16px"},children:"Подтверждение ознакомления..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(we,{checked:d,onChange:a=>V(a.target.checked),style:{fontSize:"16px"},children:"Я ознакомился с документом"}),e.jsx("div",{style:{textAlign:"center"},children:e.jsx(g,{type:"primary",size:"large",onClick:P,disabled:!d,style:{minWidth:"200px"},children:"Подтвердить ознакомление"})})]})}):e.jsxs(I,{direction:"vertical",size:"middle",style:{width:"100%"},children:[e.jsx(u,{message:m?"Ознакомление с документом успешно подтверждено":"Вы уже ознакомлены с этим документом",type:"success",showIcon:!0}),!m&&e.jsx(X,{})]})})]})}):e.jsx("div",{style:{padding:"24px"},children:e.jsx(u,{message:"Необходима авторизация",description:"Для просмотра документа и подтверждения ознакомления необходимо войти в систему",type:"warning",showIcon:!0,action:e.jsx(g,{size:"small",onClick:()=>r("/login"),children:"Войти"})})})},Ne=()=>e.jsx(Xe,{});export{Ne as default};
